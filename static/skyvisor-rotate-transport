#!/bin/env bash

# Since transport logs may have any names and the names may change when
# different visors/transports connect, we package an archive of all the
# logs manually, instead of running logrotate on *.log in the directory.
# The file generated by this script will then be rotated by logrotate.
# It has to be added to cron

LOG_DIR="/var/log/skywire-visor/"
TRANSPORT_LOG_DIR="transports"
TRANSPORT_LOG_TAR="transports.tar.gz"

archive_dir() {
    cd $LOG_DIR
    tar -czf $TRANSPORT_LOG_TAR $TRANSPORT_LOG_DIR
}

cleanup_dir() {
    cd $LOG_DIR
    # empty archive file means that logrotate has performed a rotation
    if [ ! -s $TRANSPORT_LOG_TAR ]; then
        find "${TRANSPORT_LOG_DIR}/" -type f -delete
    fi
}

archive_dir
logrotate /etc/logrotate.d/skyvisor-transport
cleanup_dir
