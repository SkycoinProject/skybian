#!/bin/env bash

# Since transport logs may have any names and the names may change when
# different visors/transports connect, we package an archive of all the
# logs manually, instead of running logrotate on *.log in the directory.
# The file generated by this script will then be rotated by logrotate.
# It has to be added to cron

LOG_DIR="/var/log/skywire-visor/"
TRANSPORT_LOG_DIR="transports"
TRANSPORT_LOG_TAR="transports.tar.gz"

rotate_dir() {
    cd $LOG_DIR
    local tar_rotated=false
    if [ ! -s $TRANSPORT_LOG_TAR ]; then
        echo "rotated recently!"
        tar_rotated=true
    fi

    tar -czf $TRANSPORT_LOG_TAR $TRANSPORT_LOG_DIR
    if [ "$tar_rotated" = true ] ; then
        echo "removing"
        find "${TRANSPORT_LOG_DIR}/" -type f -delete
    fi
}

rotate_dir
